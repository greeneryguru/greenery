{% extends "base.html" %}
{% block headers %}
    <script>
    var ICON_MAP = {};
    var TEMPERATURE = "{{ temperature }}";
    
    function celsiusToFahrenheit(v) {
        var f = 9.0/5.0 * v + 32;
        return f.toFixed(1);
    }
     
    function measurementSuffix(m) {
        var s = {
            "temperature": "&deg;",
            "humidity": "&percnt;",
            "soil-moisture": "&percnt;",
            "co2-ppm": "ppm",
            "battery": "&percnt;"
        }
        if (m in s) {
            return s[m];
        } else {
            return "";
        }
    }
    
    function updateMeasurement(id) {
        $.get("/measurement/sensor/" + id,
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                populateMeasurement(data);
            },
            'json'
        );    
    }
    
    function populateMeasurement(data) {
        $.each(data, function(i, o){
            var suffix = measurementSuffix(o.type);
            var myvalue = o.value;
            
            if (o.type == "temperature" && TEMPERATURE == "f") {
                myvalue = celsiusToFahrenheit(myvalue);
            }
            
            myvalue = myvalue.toString() + suffix;
            
            if (o.type == "battery") {
                var foo = 1;
            } else {
                var tag = [o.type, o.sensor].join(".");
                if ($(document.getElementById(tag)).length) {
                    $(document.getElementById(["value",tag].join("."))).html(" " + myvalue);
                } else {
                    var x = '<div class="measurement-widget" id="' + tag + '">';
                    x += '<i style="color: #777;" class="' + ICON_MAP[o.type].join(" ") + '"></i>';
                    x += '<div class="measurement-value" id="' + ["value",tag].join(".") + '"> ';
                    x += myvalue;
                    x += "</div>";
                    x += "</div>";
                    $(document.getElementById(o.sensor)).append(x);
                }
            }
        });
    }
    
    $(document).ready(function() {
        $.get("/measurement-icons",
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                ICON_MAP = data;
            },
            'json'
        );
                
        $(".sensor-widget").each(function() {
            var id = this.id;
            updateMeasurement(id);                
        });
        
        setInterval(function() {
            $(".sensor-widget").each(function() {
                var id = this.id;
                updateMeasurement(id);                
            });
        }, 15000);
    });
    
    </script>
{% endblock headers %}
{% block content %}
{% if sensors %}
    {% for s in sensors %}
    <div class="row white gap">
        <div class="twelve columns">
            <div class="sensor-widget padded" id="{{ s.address }}">
                <div class="battery measurement" id="battery.{{ s.address }}">
                    <i class="fas fa-battery-full" id="icon.battery.{{ s.address }}"></i>
                </div>
                <p>{{ s.name | upper }}</p>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    No data available
{% endif %}
{% endblock %}
