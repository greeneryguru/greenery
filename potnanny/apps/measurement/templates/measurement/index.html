{% extends "base.html" %}
{% block headers %}
    <script>
    var ICON_MAP = {};
    
    function scrubID(id) {
        return id.replace(/:/g, "\\:");
    }
    
    function updateMeasurement(id) {
        $.get("/measurement/sensor/" + id,
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                $.each(data, function(i, o){
                    if (o.type == "battery") {
                        var foo = 1;
                    } else {
                        var tag = scrubID([o.type, o.sensor].join("."));
                        if($("#" + tag).length) {
                            $("#value." + tag).text(o.value);
                        } else {
                            var payload = '<div class="measurement-widget" id=' + tag + '>';
                            payload += '<i class="' + ICON_MAP[o.type].join(" ") + '"></i>';
                            payload += '<div class="measurement-value" id="value.' + tag + '">';
                            payload += o.value;
                            payload += "</div>"; 
                            $("#" + scrubID(o.sensor)).append(payload);
                        }
                    }
                });
            }, 
        'json');    
    }
    
    $(document).ready(function() {
        $.get("/measurement-icons",
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                ICON_MAP = data;
            },
            'json'
        );
                
        $(".sensor-widget").each(function() {
            var id = this.id;
            updateMeasurement(id);                
        });
        
        setInterval(function() {
            $(".sensor-widget").each(function() {
                var id = this.id;
                updateMeasurement(id);                
            });
        }, 10000);
    });
    
    </script>
{% endblock headers %}
{% block content %}
{% if sensors %}
    {% for s in sensors %}
    <div class="row white gap">
        <div class="twelve columns">
            <div class="sensor-widget padded" id="{{ s.address }}">
                <div class="battery measurement" id="battery.{{ s.address }}">
                    <i class="fas fa-battery-full" id="battery.icon.{{ s.address }}"></i>
                </div>
                <p>{{ s.name | upper }}</p>
                
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    No data available
{% endif %}
{% endblock %}
