{% extends "base.html" %}
{% block headers %}
    <script>
    var ICON_MAP = {};
    
    function escapeColons(val) {
        return val.replace(/:/g, "\\:");
    }
    
    function unEscapeColons(val) {
        return val.replace(/\\:/g, ":");
    }
    
    function populateMeasurement(data, id) {
        $.each(data, function(i, o){
            if (o.type == "battery") {
                var foo = 1;
            } else {
                var tag = escapeColons([o.type, o.sensor].join("."));
                if($("#" + tag).length) {
                    $("#value." + tag).text(o.value);
                } else {
                    var x = '<div class="measurement-widget" id="' + tag + '">';
                    x += '<i class="' + ICON_MAP[o.type].join(" ") + '"></i>';
                    x += '<div class="measurement-value" id="value.' + tag + '">';
                    x += o.value;
                    x += "</div>";
                    $("#" + escapeColons(o.sensor)).append(x);
                }
            }
        });
    }
    
    function updateMeasurement(id) {
        $.get("/measurement/sensor/" + unEscapeColons(id),
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                JSON.stringify(data);
                populateMeasurement(data, id);
            },
            'json'
        );    
    }
    
    $(document).ready(function() {
        $.get("/measurement-icons",
            {'csrfmiddlewaretoken': '{{ csrf_token() }}'},
            function(data){
                ICON_MAP = data;
            },
            'json'
        );
                
        $(".sensor-widget").each(function() {
            var id = this.id;
            updateMeasurement(id);                
        });
        
        setInterval(function() {
            $(".sensor-widget").each(function() {
                var id = this.id;
                updateMeasurement(id);                
            });
        }, 15000);
    });
    
    </script>
{% endblock headers %}
{% block content %}
{% if sensors %}
    {% for s in sensors %}
    <div class="row white gap">
        <div class="twelve columns">
            <div class="sensor-widget padded" id="{{ s.address | replace(':', '\\:') }}">
                <div class="battery measurement" id="battery.{{ s.address | replace(':', '\\:') }}">
                    <i class="fas fa-battery-full" id="icon.battery.{{ s.address | replace(':', '\\:') }}"></i>
                </div>
                <p>{{ s.name | upper }}</p>
                
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    No data available
{% endif %}
{% endblock %}
