{% extends "base.html" %}
{% block headers %}
  <script>
    var csrf_token = "{{ csrf_token() }}";
    
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
            }
        }
    });
    
    function setSwitchValid(pk, data) {
        if (data.relay == 'open') {
            $("#outletswitch-" + pk).prop("checked", true);
        } else {
            $("#outletswitch-" + pk).prop("checked", false);
        }
    }
    $(document).ready(function() {
        $(".onoffswitch-checkbox").each(function(){
            var pk = this.id.split('-').slice(1,).join('-');
            $.get("/outlet/" + pk,
            {'csrfmiddlewaretoken': csrf_token},
            function(data){
                setSwitchValid(pk, data);
            }, 'json');
        });
        setInterval(function(){
            $(".onoffswitch-checkbox").each(function(){
                var pk = this.id.split('-').slice(1,).join('-');
                $.get("/outlet/" + pk,
                {'csrfmiddlewaretoken': csrf_token},
                function(data){
                    setSwitchValid(pk, data);
		        }, 'json');
            });
        }, 10000);
        $(".onoffswitch-checkbox").change(function(){
            var pk = this.id.split('-').slice(1,).join('-');
            $.post("/outlet/" + pk + "/toggle",
                {'csrfmiddlewaretoken': csrf_token},
                function(data){
                    setSwitchValid(pk, data);
			    }, 'json');
        });
    });
    </script>  
{% endblock %}
{% block content %}

<div class="row white gap">
    <div class="twelve columns">
    {% if title %}
    <h4 class="padded">{{ title }}</h4>
    {% endif %}
    </div>
</div>

{% if payload %}
    {% for o in payload %}
    <div class="row white gap">
        <div class="twelve columns">
            <p class="padded">
            <div style="display: inline-block; padding-left: 10px;">
            {{ o.deviceName }}
            </div>
            <div class="onoffswitch" id="onoffswitch-{{ o.id }}" style="float: right; padding-right: 10px;">
                <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="outletswitch-{{ o.id }}" style="display: none">
                <label class="onoffswitch-label" for="outletswitch-{{ o.id }}">
                    <span class="onoffswitch-inner"></span>
                </label>
            </div>
            </p>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="row white gap">
        <div class="twelve columns">
            <p class="padded">
            No outlets defined in Vesync app
            </p>
        </div>
    </div>
{% endif %}
{% endblock %}
