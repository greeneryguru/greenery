{% extends "base.html" %}
{% block headers %}
  <script src="{{ url_for('static',  filename='js/Chart.bundle.min.js') }}"></script>
  <script src="{{ url_for('static',  filename='js/chartbuilder.js') }}"></script>
  <script>
    var globalChartRefs = {};
    var overflowStates = {};

    /*
     * load chart data for particular element
     */
    function load_chart(id) {
      var atoms = id.split("_");

      $.get("{{ url_for('measurement.simple_graph') }}",
        { "sensors": atoms[1], "measurements": atoms[2], "hours": 24 },
        function(data){
          createChart(id, data, globalChartRefs);
        }, 'json');
    }

    $(document).ready(function() {
      /*
       * load our initial chart div overflow states, as thats what
       * defines 'visible' or not with the mini.css 'collapse' elements
       */
      $("[id*=chartdiv_]").each(function() {
        var id = this.id;
        var ovf = $("#" + this.id).css("overflow");
        overflowStates[this.id] = ovf;
      });

      /*
       * monitor for the chartdivs becoming visible
       */
       setInterval(function(){
         $("[id*=chartdiv_]").each(function() {
           var id = this.id;
           var ovf = $("#" + this.id).css("overflow");
           var atoms = id.split("_");
           var chart_id = ["chart",atoms[1],atoms[2]].join("_");
           if ( ovf != overflowStates[id] && ovf == "auto" ) {
             load_chart(chart_id);
           }
           overflowStates[id] = ovf;
         });
       },200);

      /*
       * refresh open graphs every n seconds
       */
      setInterval(function(){
        $("[id*=chart_]").each(function(){
          var id = this.id;
          var atoms = id.split("_");
          var chartdiv = ["chartdiv",atoms[1],atoms[2]].join("_");
          if (overflowStates[chartdiv] == 'auto') {
            load_chart(id);
          }
        });
      }, 5000);

      /*
       * refresh sensor measurements every n seconds
       */
      setInterval(function(){
        $("[id*=card_]").each(function(){
          var id = this.id;
          var atoms = id.split("_");
          $.get("/sensors/" + atoms[1] + "/measurements", {},
            function(data){
              for (k in data["measurements"]) {
                var myid = "gauge_" + atoms[1] + "_" + k;
                var myvalue = data["measurements"][k].toFixed(1);
                if (k == "temperature") {
                  $("#" + myid).text(myvalue + "\xB0");
                } else if (k == "humidity" || k == "soil-moisture") {
                  $("#" + myid).text(myvalue + "%");
                } else {
                  $("#" + myid).text(myvalue);
                }
              }
            }, 'json');
        });
      }, 20000);
    });
  </script>
{% endblock headers %}
{% block content %}
{% if title %}
  <h3>{{ title }}</h3>
{% endif %}
{% if payload %}
  <div class="row">
  {% for sensor in payload %}
      <div class="card" id="card_{{ sensor.id }}">
        <div class="section dark">
          {% if 'battery' in sensor.measurements %}
            {% if sensor.measurements.battery > 75 %}
              <i class="fas fa-battery-full" style="float: right;" title="{{ sensor.measurements.battery }}%"></i>
            {% elif sensor.measurements.battery > 50 %}
              <i class="fas fa-battery-three-quarters" style="float: right;" title="{{ sensor.measurements.battery }}%"></i>
            {% elif sensor.measurements.battery > 25 %}
              <i class="fas fa-battery-half" style="float: right;" title="{{ sensor.measurements.battery }}%"></i>
            {% else %}
              <i class="fas fa-battery-quarter" style="float: right; color: red;" title="{{ sensor.measurements.battery }}%"></i>
            {% endif %}
          {% endif %}
          <h4><a href="{{ url_for('sensor.edit', pk=sensor.id) }}">{{ sensor.name }}</a></h4>
        </div>
        <div class="section">
          <div class="collapse">
        {% for k, v in sensor.measurements.items() %}
          {% if k != 'battery' %}
              <input type="checkbox" id="collapse_{{ sensor.id }}_{{ k }}" aria-hidden="true">
              <label for="collapse_{{ sensor.id }}_{{ k }}" aria-hidden="true" style="text-align: center;" title="click for graph">
                {% if k == 'temperature' %}
                  <b id="gauge_{{ sensor.id }}_{{ k }}" style="font-size: 1.5em; font-weight: normal;">{{ v }}&#176;</b>
                  {{ k }}
                {% elif k == 'humidity' or k == 'soil-moisture' %}
                  <b id="gauge_{{ sensor.id }}_{{ k }}" style="font-size: 1.5em; font-weight: normal;">{{ v }}%</b>
                  {{ k }}
                {% else %}
                  <b id="gauge_{{ sensor.id }}_{{ k }}" style="font-size: 1.5em; font-weight: normal;">{{ v }}</b>
                  {{ k }}
                {% endif %}
              </label>
              <div id="chartdiv_{{ sensor.id }}_{{ k }}">
                <canvas id="chart_{{ sensor.id }}_{{ k }}"></canvas>
              </div>
          {% endif %}
        {% endfor %}
        </div>
      </div>
  {% endfor %}
  </div>
{% else %}
No Sensor Data
{% endif %}
{% endblock %}
